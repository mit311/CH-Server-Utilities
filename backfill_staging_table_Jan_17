-- Create all_facts_local with replication
DROP table summarydata.stg_all_facts_backfill ON cluster 'all-replicated';
CREATE TABLE IF NOT EXISTS staging.stg_all_facts_backfill ON CLUSTER 'reporting-dev01' (
    `hour` DateTime,
    `advertiser_id` Int32,
    `campaign_group_id` Int32 DEFAULT 0,
    `campaign_id` Int32 DEFAULT 0,
    `channel_id` Int32 DEFAULT 0,
    `objective_id` Int32 DEFAULT 0,
    `group_id` Int32 DEFAULT 0,
    `creative_id` Int32 DEFAULT 0,
    `private_marketplace_id` String DEFAULT '',
    `country` LowCardinality(String) DEFAULT '',
    `metro_id` Int32 DEFAULT 0,
    `region` LowCardinality(String) DEFAULT '',
    `city` LowCardinality(String) DEFAULT '',
    `postal_code` LowCardinality(String) DEFAULT '',
    `domain` String DEFAULT '',
    `display_impressions` Int32 DEFAULT 0,
    `ctv_impressions` Int32 DEFAULT 0,
    `media_cost` Decimal(18, 9) DEFAULT 0.0,
    `fee_cost` Decimal(18, 9) DEFAULT 0.0,
    `partner_cost` Decimal(18, 9) DEFAULT 0.0,
    `data_cost` Decimal(18, 9) DEFAULT 0.0,
    `media_spend` Decimal(18, 9) DEFAULT 0.0,
    `data_spend` Decimal(18, 9) DEFAULT 0.0,
    `platform_spend` Decimal(18, 9) DEFAULT 0.0,
    `legacy_spend` Decimal(18, 9) DEFAULT 0.0,
    `ctv_spend` Decimal(18, 9) DEFAULT 0.0,
    `views` Int32 DEFAULT 0,
    `clicks` Int32 DEFAULT 0,
    `view_conversions` Int32 DEFAULT 0,
    `click_conversions` Int32 DEFAULT 0,
    `view_order_value` Decimal(18, 9) DEFAULT 0.0,
    `click_order_value` Decimal(18, 9) DEFAULT 0.0,
    `view_impression` Int32 DEFAULT 0,
    `view_viewed` Int32 DEFAULT 0,
    `view_untrackable` Int32 DEFAULT 0,
    `vast_start` Int32 DEFAULT 0,
    `vast_firstquartile` Int32 DEFAULT 0,
    `vast_midpoint` Int32 DEFAULT 0,
    `vast_thirdquartile` Int32 DEFAULT 0,
    `vast_complete` Int32 DEFAULT 0,
    `uniques_arr` Array(Nullable(String)) DEFAULT[],
    `unlinked_spend` Decimal(18, 9) DEFAULT 0.0,
    `supply_vendor` String DEFAULT '',
    `bids` Int32 DEFAULT 0,
    `new_visitors` Int32 DEFAULT 0,
    `raw_existing_site_visitors_arr` Array(Nullable(String)) DEFAULT[],
    `raw_new_site_visitors_arr` Array(Nullable(String)) DEFAULT[],
    `existing_users_reached_arr` Array(Nullable(String)) DEFAULT[],
    `new_users_reached_arr` Array(Nullable(String)) DEFAULT[],
    `existing_site_visitors_arr` Array(Nullable(String)) DEFAULT[],
    `new_site_visitors_arr` Array(Nullable(String)) DEFAULT[],
    `site_visitors_arr` Array(Nullable(String)) DEFAULT[],
    `new_to_file` Int32 DEFAULT 0,
    `raw_visits` Int32 DEFAULT 0,
    `raw_conversions` Int32 DEFAULT 0,
    `visitors_arr` Array(Nullable(String)) DEFAULT[],
    `raw_order_value` Int64 DEFAULT 0,
    `first_touch_visits` Int32 DEFAULT 0,
    `device_type` String DEFAULT '',
    `last_tv_touch_clicks` Int32 DEFAULT 0,
    `last_tv_touch_views` Int32 DEFAULT 0,
    `last_tv_touch_click_conversions` Int32 DEFAULT 0,
    `last_tv_touch_view_conversions` Int32 DEFAULT 0,
    `last_tv_touch_click_order_value` Decimal(18, 9) DEFAULT 0.0,
    `last_tv_touch_view_order_value` Decimal(18, 9) DEFAULT 0.0,
    `last_touch_clicks` Int32 DEFAULT 0,
    `last_touch_views` Int32 DEFAULT 0,
    `last_touch_click_conversions` Int32 DEFAULT 0,
    `last_touch_click_order_value` Decimal(18, 9) DEFAULT 0.0,
    `last_touch_view_order_value` Decimal(18, 9) DEFAULT 0.0,
    `visits_assist` Int32 DEFAULT 0,
    `conversions_assist_click` Int32 DEFAULT 0,
    `conversions_assist_view` Int32 DEFAULT 0,
    `conversions_assist_click_order_value` Decimal(18, 9) DEFAULT 0.0,
    `conversions_assist_view_order_value` Decimal(18, 9) DEFAULT 0.0,
    `last_touch_view_conversions` Int32 DEFAULT 0
    )
    ENGINE = ReplicatedMergeTree('/clickhouse/{cluster}/tables/{database}/{table}/{shard}', '{replica}')
    PARTITION BY toYYYYMM(hour)
    ORDER BY(advertiser_id, hour)
    SETTINGS index_granularity = 8192;



-- Create a distributed all_facts table over the local replicated table
CREATE TABLE IF NOT EXISTS summarydata.stg_all_facts ON CLUSTER 'reporting-dev01' AS summarydata.stg_all_facts_local
    ENGINE = Distributed('reporting-dev01', summarydata, stg_all_facts_local, cityHash64(advertiser_id));
